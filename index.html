<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–¢—Ä–µ–Ω–∞–∂—ë—Ä-—Ç–µ—Å—Ç ¬´–°–µ—Å—Ç—Ä–∏–Ω—Å–∫–æ–µ –¥–µ–ª–æ¬ª</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root { --bg:#0b1020; --card:#0f172a; --muted:#9ca3af; --text:#e5e7eb; --border:#1f2937; --btn:#111827; --btnb:#374151; --primary:#2563eb; --primary-b:#1d4ed8; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial;background:var(--bg);color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid var(--btnb);background:var(--btn);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary-b)}
    .btn.primary:hover{background:#1e40af}
    .muted{color:var(--muted)}
    .badge{border:1px solid var(--btnb);border-radius:999px;padding:4px 10px;font-size:12px}
    .input, select{width:100%;background:#0b1222;color:var(--text);border:1px solid var(--btnb);border-radius:10px;padding:10px 12px}
    .options{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 720px){.options{grid-template-columns:1fr} .grid{grid-template-columns:1fr} .grid4{grid-template-columns:1fr}}
    .opt{border:1px solid var(--btnb);border-radius:12px;padding:12px;background:#0b1222;cursor:pointer}
    .opt.correct{border-color:#16a34a;background:#06220f}
    .opt.wrong{border-color:#dc2626;background:#210b0b}
    .opt.chosen{outline:2px solid #334155}
    .label{font-weight:700;margin-right:6px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    .pill{padding:6px 10px;border-radius:999px;background:#0b1222;border:1px solid var(--btnb)}
    .fav{cursor:pointer}
    .itemline{border:1px solid var(--btnb);padding:8px 10px;border-radius:10px;background:#0b1222;cursor:pointer}
    .itemline.active{background:#111827}
    .footer{color:#9ca3af;font-size:12px;text-align:center;padding:24px 0}
    .alert{border-color:#f87171}
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React + ReactDOM + Babel: —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Å–±–æ—Ä–∫–∏ -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (—Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ) -->
  <script type="text/babel" data-presets="react">
    const CYR_LABELS = ['–ê','–ë','–í','–ì'];
    const LS_PREFIX = 'sestrinskoe-v2';
    const LS = {
      ANSWERS: LS_PREFIX + '-answers',
      FAVS: LS_PREFIX + '-favorites',
      MISTAKES: LS_PREFIX + '-mistakes',
    };
    const saveLS = (k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)) }catch{} };
    const loadLS = (k,f)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):f }catch{ return f } };
    const shuffle = (arr)=>{ const a=[...arr]; for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a };

    function parseQuestions(txt){
      const clean = txt.replace(/\r/g,'').trim();
      const chunks = clean.split(/\n(?=\s*\d+\.\s)/g);
      const items = [];
      for(const raw of chunks){
        const block = raw.trim();
        if(!/^\d+\./.test(block)) continue;
        let m = block.match(/^\s*(\d+)\.\s*(?:\[(.*?)\]\s*)?([\s\S]*?)\n(?=[–êA]\))/);
        let number, qtext='';
        if(m){ number = parseInt(m[1],10); qtext = (m[3]||'').replace(/\s+/g,' ').trim(); }
        else{
          const m2 = block.match(/^\s*(\d+)\.\s*([\s\S]*?)\n(?=[–êA]\))/);
          if(!m2) continue; number = parseInt(m2[1],10); qtext = (m2[2]||'').replace(/\s+/g,' ').trim();
        }
        const options = [];
        const optRe = /(^|\n)\s*([–êA–ë–í–ì])\)\s*([\s\S]*?)(?=(\n\s*[–êA–ë–í–ì]\)|$))/g;
        let mm; while((mm = optRe.exec(block))){
          const letter = mm[2] === 'A' ? '–ê' : mm[2];
          const text = (mm[3]||'').replace(/\s+/g,' ').trim();
          if(text) options.push({letter, text});
        }
        if(options.length < 2) continue;
        const correctText = (options.find(o=>o.letter==='–ê') || options[0]).text;
        items.push({ number, qtext, options, correctText });
      }
      items.sort((a,b)=>a.number-b.number);
      return items;
    }

    const Footer = () => <div className="footer">¬© {new Date().getFullYear()} –¢—Ä–µ–Ω–∞–∂—ë—Ä. –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.</div>;

    function Home({total, blocksCount, onStartTrain, onStartExam, onStartFavs, onStartMistakes}){
      const [selectedBlock, setSelectedBlock] = React.useState('all');
      const [examMinutes, setExamMinutes] = React.useState(60);
      const [examSource, setExamSource] = React.useState('selected');
      return (
        <div className="container">
          <h1 style={{margin:'8px 0 16px'}}>–¢—Ä–µ–Ω–∞–∂—ë—Ä-—Ç–µ—Å—Ç ¬´–°–µ—Å—Ç—Ä–∏–Ω—Å–∫–æ–µ –¥–µ–ª–æ¬ª</h1>
          <div className="grid4" style={{marginBottom:16}}>
            <div className="card" style={{cursor:'pointer'}} onClick={()=>onStartTrain(selectedBlock)}>
              <div className="tile-title">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</div>
              <div className="muted">–í—ã–±–æ—Ä –±–ª–æ–∫–∞ –ø–æ 100, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∏–¥–µ–Ω —Å—Ä–∞–∑—É</div>
            </div>
            <div className="card">
              <div className="tile-title">–≠–∫–∑–∞–º–µ–Ω</div>
              <div className="muted">100 —Å–ª—É—á–∞–π–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, —Ç–∞–π–º–µ—Ä</div>
              <div className="row" style={{marginTop:8}}>
                <label>–ò—Å—Ç–æ—á–Ω–∏–∫:&nbsp;</label>
                <select value={examSource} onChange={e=>setExamSource(e.target.value)}>
                  <option value="selected">–ò–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞</option>
                  <option value="all">–ò–∑ –≤—Å–µ—Ö –≤–æ–ø—Ä–æ—Å–æ–≤</option>
                </select>
              </div>
              <div className="row" style={{marginTop:8}}>
                <label>–¢–∞–π–º–µ—Ä (–º–∏–Ω):&nbsp;</label>
                <input className="input" type="number" min="5" max="240" value={examMinutes} onChange={e=>setExamMinutes(parseInt(e.target.value||'60',10))}/>
              </div>
              <button className="btn primary" style={{marginTop:8}} onClick={()=>onStartExam(selectedBlock, examSource, examMinutes)}>–ù–∞—á–∞—Ç—å —ç–∫–∑–∞–º–µ–Ω</button>
            </div>
            <div className="card" style={{cursor:'pointer'}} onClick={onStartFavs}>
              <div className="tile-title">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
              <div className="muted">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –≤–æ–ø—Ä–æ—Å—ã</div>
            </div>
            <div className="card" style={{cursor:'pointer'}} onClick={onStartMistakes}>
              <div className="tile-title">–û—à–∏–±–∫–∏</div>
              <div className="muted">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –≥–¥–µ –±—ã–ª–∏ –æ—à–∏–±–∫–∏</div>
            </div>
          </div>
          <div className="card">
            <div className="row" style={{gap:12, alignItems:'center'}}>
              <div className="pill">–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {total}</div>
              <div className="pill">–ë–ª–æ–∫–æ–≤ –ø–æ 100: {blocksCount}</div>
              <div style={{minWidth:240}}>
                <label className="muted">–í—ã–±–æ—Ä –±–ª–æ–∫–∞:</label>
                <select className="input" value={selectedBlock} onChange={e=>setSelectedBlock(e.target.value)}>
                  <option value="all">–í—Å–µ –≤–æ–ø—Ä–æ—Å—ã</option>
                  {Array.from({length: blocksCount}).map((_,i)=>(
                    <option key={i} value={String(i)}>–ë–ª–æ–∫ {i+1}</option>
                  ))}
                </select>
              </div>
            </div>
          </div>
          <Footer />
        </div>
      );
    }

    function Results({items, answers, onHome}){
      const stats = React.useMemo(()=>{
        const total = items.length;
        const answered = items.filter(q=>answers[q.number]).length;
        const correct = items.filter(q=>answers[q.number]===q.correctText).length;
        const wrongList = items.filter(q=>answers[q.number] && answers[q.number]!==q.correctText);
        return { total, answered, correct, wrongList, pct: total? Math.round(correct/total*100):0 };
      }, [items, answers]);
      return (
        <div className="container">
          <div className="row" style={{justifyContent:'space-between', marginBottom:12}}>
            <button className="btn" onClick={onHome}>‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
            <div className="row">
              <div className="pill">–í–µ—Ä–Ω–æ: {stats.correct}/{stats.total}</div>
              <div className="pill">{stats.pct}%</div>
            </div>
          </div>
          <div className="card" style={{marginBottom:16}}>
            <h2 style={{marginTop:0}}>–û—à–∏–±–∫–∏</h2>
            {stats.wrongList.length===0 ? <div className="muted">–û—à–∏–±–æ–∫ –Ω–µ—Ç üéâ</div> : null}
            <div style={{display:'grid', gap:10}}>
              {stats.wrongList.map(q=>(
                <div key={q.number} className="card" style={{padding:12}}>
                  <div className="muted">‚Ññ {q.number}</div>
                  <div style={{margin:'6px 0 8px'}}>{q.qtext}</div>
                  <div><b>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π:</b> {q.correctText}</div>
                </div>
              ))}
            </div>
          </div>
          <Footer />
        </div>
      );
    }

    function TestView({mode, items, onExit, onFinishExam}){
      const [idx, setIdx] = React.useState(0);
      const [answers, setAnswers] = React.useState(()=>loadLS(LS.ANSWERS, {}));
      const [favs, setFavs] = React.useState(()=>loadLS(LS.FAVS, {}));
      const [mistakes, setMistakes] = React.useState(()=>loadLS(LS.MISTAKES, {}));
      const [startTs] = React.useState(()=>Math.floor(Date.now()/1000));
      const [now, setNow] = React.useState(()=>Math.floor(Date.now()/1000));
      const [timerMin] = React.useState(()=> (mode.type==='exam' ? mode.minutes : null));

      React.useEffect(()=>{
        if(mode.type!=='exam') return;
        const t = setInterval(()=>setNow(Math.floor(Date.now()/1000)), 1000);
        return ()=>clearInterval(t);
      }, [mode.type]);

      const remainingSec = React.useMemo(()=>{
        if(mode.type!=='exam') return null;
        const elapsed = now - startTs;
        return Math.max(0, (timerMin*60) - elapsed);
      }, [now, startTs, timerMin, mode.type]);

      React.useEffect(()=>{
        if(mode.type==='exam' && remainingSec===0){
          onFinishExam({items, answers});
        }
      }, [remainingSec]);

      const view = items[idx] || null;
      const progress = React.useMemo(()=>{
        const total = items.length || 1;
        const answered = items.filter(q=>answers[q.number]).length;
        return { total, answered, pct: Math.round(answered/total*100) };
      }, [items, answers]);

      function pick(q, text){
        const na = { ...answers, [q.number]: text };
        setAnswers(na); saveLS(LS.ANSWERS, na);
        if(text !== q.correctText){
          const nm = { ...mistakes, [q.number]: true };
          setMistakes(nm); saveLS(LS.MISTAKES, nm);
        }
      }
      function toggleFav(q){
        const nf = { ...favs };
        if(nf[q.number]) delete nf[q.number]; else nf[q.number] = true;
        setFavs(nf); saveLS(LS.FAVS, nf);
      }

      return (
        <div className="container">
          <div className="row" style={{justifyContent:'space-between', marginBottom:8}}>
            <button className="btn" onClick={onExit}>‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
            <div className="row" style={{gap:8, alignItems:'center'}}>
              <div className="pill">–†–µ–∂–∏–º: {mode.title}</div>
              <div className="pill">–û—Ç–≤–µ—á–µ–Ω–æ: {progress.answered}/{progress.total}</div>
              <div className="pill">{progress.pct}%</div>
              {mode.type==='exam' ? (
                <div className={'pill ' + (remainingSec<=60?'alert':'')} title="–û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è">
                  ‚è± {String(Math.floor(remainingSec/60)).padStart(2,'0')}:{String(remainingSec%60).padStart(2,'0')}
                </div>
              ):null}
              {mode.type==='exam' ? <button className="btn primary" onClick={()=>onFinishExam({items, answers})}>–ó–∞–≤–µ—Ä—à–∏—Ç—å —ç–∫–∑–∞–º–µ–Ω</button> : null}
            </div>
          </div>

          {view ? (
            <div className="grid">
              <
